<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KNN Bench — Мини UI</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin: 20px; }
    .row { margin-bottom: 12px; }
    .btn { padding: 8px 12px; background:#0b5fff; color:#fff; border:0; border-radius:6px; cursor:pointer; }
    .btn:disabled { background:#8aa8ff; cursor:not-allowed; }
    .progress { width: 100%; height: 16px; background:#eee; border-radius:8px; overflow:hidden; }
    .bar { height: 100%; background:#0b5fff; width:0%; transition: width .2s; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    #log { height: 300px; overflow: auto; border:1px solid #ddd; padding:8px; border-radius:6px; background:#fafafa; }
    label { display:inline-block; width: 140px; color:#555; }
    input[type="text"] { width: 420px; padding:6px 8px; }
  </style>
</head>
<body>
  <h2>KNN Bench — Минимальный прогресс</h2>

  <div class="row">
    <label>Config:</label>
    <input id="cfg" type="text" value="configs/ball_prune_small.yaml" />
    <button id="run" class="btn">Запустить</button>
  </div>

  <div class="row">
    <label>Статус:</label>
    <span id="status">idle</span>
  </div>

  <div class="row">
    <label>Текущий шаг:</label>
    <span id="current">—</span>
  </div>

  <div class="row">
    <div class="progress"><div id="bar" class="bar"></div></div>
    <div><span id="seen">0</span>/<span id="total">0</span></div>
  </div>

  <div class="row">
    <label>Логи:</label>
  </div>
  <div id="log" class="mono"></div>

  <script>
    const runBtn = document.getElementById('run');
    const cfgInput = document.getElementById('cfg');
    const statusEl = document.getElementById('status');
    const currentEl = document.getElementById('current');
    const barEl = document.getElementById('bar');
    const seenEl = document.getElementById('seen');
    const totalEl = document.getElementById('total');
    const logEl = document.getElementById('log');

    function setProgress(seen, total) {
      seenEl.textContent = seen;
      totalEl.textContent = total;
      const pct = total > 0 ? Math.min(100, Math.round(seen * 100 / total)) : 0;
      barEl.style.width = pct + '%';
    }

    function setCurrent(cur) {
      const a = cur.algo || '—';
      const d = cur.dataset || '—';
      const k = (cur.k !== null && cur.k !== undefined) ? cur.k : '—';
      currentEl.textContent = `${a} @ ${d} k=${k}`;
    }

    function addLog(line) {
      if (!line) return;
      const atBottom = logEl.scrollTop + logEl.clientHeight >= logEl.scrollHeight - 2;
      logEl.textContent += line + '\n';
      if (atBottom) logEl.scrollTop = logEl.scrollHeight;
    }

    // SSE stream
    const es = new EventSource('/stream');
    es.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        if (msg.type === 'hello') {
          statusEl.textContent = msg.status;
          setProgress(msg.seen || 0, msg.total || 0);
          setCurrent(msg.current || {});
          if (msg.status === 'running') runBtn.disabled = true;
        } else if (msg.type === 'log') {
          addLog(msg.line);
        } else if (msg.type === 'progress') {
          setProgress(msg.seen, msg.total);
          setCurrent(msg.current || {});
        } else if (msg.type === 'status') {
          statusEl.textContent = msg.status;
          runBtn.disabled = (msg.status === 'running');
        }
      } catch (_) { /* noop */ }
    };

    runBtn.onclick = async () => {
      runBtn.disabled = true;
      statusEl.textContent = 'running';
      setProgress(0, 0);
      setCurrent({});
      logEl.textContent = '';
      try {
        const res = await fetch('/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config_path: cfgInput.value.trim() })
        });
        const data = await res.json();
        if (!data.ok) {
          addLog('Ошибка запуска: ' + (data.error || 'unknown'));
          statusEl.textContent = 'error';
          runBtn.disabled = false;
        } else {
          // totals may be known now
          if (data.status) {
            setProgress(data.status.seen || 0, data.status.total_steps || 0);
          }
        }
      } catch (e) {
        addLog('Исключение: ' + e);
        statusEl.textContent = 'error';
        runBtn.disabled = false;
      }
    };
  </script>
</body>
</html>

